<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Dreamscape

  </title>
  <link rel="stylesheet" href="style.css">
  <script async src="opencv.js" onload="onOpenCvReady();"></script>
</head>

<body>
  <h2>Welcome to Dreamscape</h2>
  <video id="videoInput" width="640" height="480" hidden="true"></video>

  <div class="inputoutput">
    <canvas id="canvasOutput"></canvas>
  </div>

  <script type="text/javascript">
    const outputCanvas = document.getElementById('canvasOutput');
    const FPS = 30;
    let filter
    let cvReady = false;
    let width;
    let height;
    let video;
    let vc;
    let src;
    let dst;
    let streaming;

    function onOpenCvReady() {
      cv['onRuntimeInitialized'] = () => {
        console.log("OpenCV.js is ready.");
        cvReady = true;

        video = document.getElementById("videoInput");
        console.log(video)
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
          .then(function (stream) {
            video.srcObject = stream;
            video.play();
          })
          .catch(function (err) {
            console.log("An error occurred! " + err);
          });

        // console.log(video.videoHeight)
        // console.log(video)
        height = video.videoHeight;
        // console.log(height)
        width = video.videoWidth;
        // video.setAttribute('width', width);
        // video.setAttribute('height', height);
        // console.log(video)
        streaming = true;
        vc = new cv.VideoCapture(video);

        src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        dst = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        filter = "canny"

        setTimeout(processVideo, 0);
      };
    }


    function gray(src) {
      cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
      // cv.flip(dst, 1, dst);
      return dst;
    }
    function passthrough(src) {
      dst = src;
      return dst;
    }

    function cannyRainbow(src) {
      cv.Canny(src, dst, 40, 90, 3, false)

      // let hue = map(angle, -PI, PI, 0, 360); //create a color wheel

      // let col = color(hue, 100, constrain(magnitude, 0, 100));
      // let idx = 4 * (x + y * w);

      // pixels[idx] = red(col);
      // pixels[idx + 1] = green(col);
      // pixels[idx + 2] = blue(col);
      // pixels[idx + 3] = 255;
      return dst
    }

    async function processVideo() {
      if (!streaming) return;

      let begin = Date.now();

      // stats.begin();
      vc.read(src);

      switch (filter) {
        case "none":
          await applyOperation(passthrough);
          break;
        case "gray":
          await applyOperation(gray);
          break;
        case "canny":
          await applyOperation(cannyRainbow);
          break;
        default:
          await applyOperation(passthrough)

      }
      cv.imshow(outputCanvas, dst);


      let delay = 1000 / FPS - (Date.now() - begin);
      setTimeout(processVideo, delay);
    }


    function applyOperation(operation) {
      operation(src); // Execute the OpenCV function
    };


    function saveImage() {
      outputCanvas.toBlob((blob) => {
        let url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url;
        a.download = url
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)


        // TODO - send image to  API

      });
    }

    document.onkeypress = (e) => {
      console.log(e.key)
      switch (e.key) {
        // case "0":
        //   filter = "none"
        //   break;
        case "a":
          filter = "canny"
          break;
        case "s":
          filter = "gray"
          break;
        case "f":
          saveImage();
          break;

      }
    }

  </script>
</body>

</html>